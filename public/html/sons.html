<div class="content-container">
  <div class="genre-buttons" id="genre-buttons">
      <!-- Genre buttons will be added dynamically -->
  </div>
  <div id="song-slider" class="song-slider">
      <!-- Songs will be loaded here dynamically -->
  </div>
</div>

<script>
  const API_BASE_URL = 'http://localhost:8000';
  let playlist = [];
  let isAuthenticated = false;

  // Simulated authentication check (replace with real logic)
  function checkAuthentication() {
        // Simulate fetching auth status from an API or session
        // Set `isAuthenticated = true` if the user is logged in
        return new Promise(resolve => {
            setTimeout(() => {
                isAuthenticated = true; // Example: Assume the user is authenticated
                resolve(isAuthenticated);
            }, 1000); // Simulate network delay
        });
    }

    function createGenreButtons() {
        const genres = ['Mixed', 'Rock', 'Pop', 'Jazz', 'Classical', 'Hip-Hop'];
        const buttonsContainer = document.getElementById('genre-buttons');
        
        genres.forEach(genre => {
            const button = document.createElement('button');
            button.className = `genre-button ${genre === 'Mixed' ? 'active' : ''}`;
            button.textContent = genre;
            button.addEventListener('click', () => selectGenre(genre));
            buttonsContainer.appendChild(button);
        });
    }

    function formatDuration(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    async function getSongDuration(songId) {
        return new Promise((resolve) => {
            const audio = new Audio(`${API_BASE_URL}/audio/${songId}`);
            
            audio.addEventListener('loadedmetadata', () => {
                resolve(formatDuration(audio.duration));
                audio.remove(); // Clean up
            });

            audio.addEventListener('error', () => {
                resolve('0:00'); // Default duration on error
                audio.remove(); // Clean up
            });
        });
    }

    async function loadSongs(genre = 'Mixed') {
        try {
            const response = await fetch(
              genre === 'Mixed' 
              ? `${API_BASE_URL}/songs` 
              : `${API_BASE_URL}/music/${genre}`
            );
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const songs = await response.json();
            await displaySongs(songs, genre);
        } catch (error) {
            console.error('Error loading songs:', error);
            document.getElementById('song-slider').innerHTML = 
                `<p>Error loading songs for ${genre}. Please try again.</p>`;
        }
    }

    async function displaySongs(songs, currentGenre) {
        const songSlider = document.getElementById('song-slider');
        
        if (!songs || (Array.isArray(songs) && songs.length === 0)) {
            songSlider.innerHTML = `<p>No songs found for ${currentGenre}</p>`;
            return;
        }

        songSlider.innerHTML = '<p>Loading songs...</p>';
        const songsArray = Array.isArray(songs) ? songs : [songs];
        
        const songsHtml = songsArray.map(song => `
            <div class="song">
                <img src="${API_BASE_URL}/cover/${song.id}" alt="Cover" class="song-cover">
                <div class="song-info">
                    <p class="song-title">${song.title}</p>
                    <p class="song-artist">${song.artist || 'Unknown Artist'}</p>
                </div>
                <p class="song-duration" id="duration-${song.id}">...</p>
                <button class="add-to-playlist" 
                    onclick="addToPlaylist(${song.id}, '${song.title}', '${song.artist || 'Unknown Artist'}')" 
                    ${isAuthenticated ? '' : 'disabled'}>
                    Add to Playlist
                </button>
            </div>
        `).join('');
        
        songSlider.innerHTML = songsHtml;

        for (const song of songsArray) {
            const duration = await getSongDuration(song.id);
            const durationElement = document.getElementById(`duration-${song.id}`);
            if (durationElement) {
                durationElement.textContent = duration;
            }
        }
    }

    function addToPlaylist(id, title, artist) {
        if (!isAuthenticated) {
            alert('You need to log in to add songs to your playlist.');
            return;
        }
        playlist.push({ id, title, artist });
        updatePlaylist();
    }

    function removeFromPlaylist(index) {
        playlist.splice(index, 1);
        updatePlaylist();
    }

    function updatePlaylist() {
        const playlistContainer = document.getElementById('playlist');
        
        if (playlist.length === 0) {
            playlistContainer.innerHTML = `<p>No songs in your playlist yet.</p>`;
            return;
        }
        
        const playlistHtml = playlist.map((song, index) => `
            <div class="playlist-song">
                <span>${song.title} - ${song.artist}</span>
                <span class="remove-song" onclick="removeFromPlaylist(${index})">Remove</span>
            </div>
        `).join('');
        
        playlistContainer.innerHTML = playlistHtml;
    }

    function selectGenre(genre) {
        document.querySelectorAll('.genre-button').forEach(button => {
            button.classList.remove('active');
            if (button.textContent === genre) {
                button.classList.add('active');
            }
        });
        loadSongs(genre);
    }

    // Initialize everything when the script loads
    checkAuthentication().then(() => {
        createGenreButtons();
        loadSongs('Mixed');
    });
  </script>
</body>
</html>